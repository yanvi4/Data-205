---
title: "Project Data 205 - Crime Density by city in Montgomery County, MD"
author: "Hye Young Park"
date: "4/7/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readr)
library(lubridate)
library(RColorBrewer)
library(reshape2)
library(plotly)
library(ggthemes)
library(gapminder)
library(gganimate)
library(tibble)
library(ggalluvial)
library(corrplot)
library(parcats)
library(easyalluvial)
library(ggpubr)
```

## Load Datasets
```{r}
#Data1: Median House price
data1h <- read.csv(file = "C:/Users/illya/Desktop/DATA 205 Spring 2020/Datasets from Zillow/city_Zhvi_AllHomes.csv", check.names = FALSE)

#Data2: Police Dispached Incidents
data2p <- read.csv(file = "C:/Users/illya/Desktop/DATA 205 Spring 2020/Datasets from dataMontgomery/Police_Dispatched_Incidents.csv")

#Population of Montgomery County
data3pop <- read.csv(file = "C:/Users/illya/Desktop/DATA 205 Spring 2020/Datasets from Census Bureau/mcpopulation.csv")
```


## Cleaning and Filtering Datasets
### Information of datasets
```{r}
str(data1h)

#convert the coulumn of "Priority" from integer to string
data2p$Priority <- as.character(data2p$Priority)
str(data2p)

str(data3pop)
```

### Remove NA values and unnecassary columns and rows
#### Data1: Median House Price from 01/2017 to 12/2019
```{r}
data1h <- data1h[-c(1, 4, 6:255, 292, 293)]
dim(data1h)
head(data1h)

data1h <- filter(data1h, State == "MD")
names(data1h)[names(data1h) == "RegionName"] <- "city"
data1h <- filter(data1h, CountyName == "Montgomery County")
data1h$city <- gsub("Sandy Spring", "Ashton-Sandy Spring", data1h$city)
head(data1h)

data1hc <- filter(data1h, 
                   city == "Ashton-Sandy Spring" | city == "Barnesville" | city ==
                    "Beallsville" | city == "Bethesda" | city == "Boyds" | city == 
                    "Brinklow" | city == "Brookeville" | city == "Cabin John" | city
                   == "Chevy Chase" | city == "Clarksburg" | city == "Damascus" | city 
                   == "Derwood" | city == "Dickerson"| city == "Gaithersburg" | city
                   == "Garrett Park" | city == "Germantown" | city == "Glen Echo" | 
                    city == "Kensington" | city == "Montgomery Village" | city == "Olney"
                  | city == "Poolesville" | city == "Potomac" | city == "Rockville" |
                    city == "Silver Spring" | city == "Spencerville" | city == 
                    "Washington Grove"
                   )
#drop Brookville due to outlier with big number
data1hc <- filter(data1hc, city !="Brookeville") 
data1hc[, 1] = toupper(data1hc[, 1])
data1hc <- data1hc[-c(2, 3)]
head(data1hc)
```


#### Data2: Police Dispached Incidents
```{r}
names(data2p)[names(data2p) == "City"] <- "city"

data2p1 <- data2p[!(is.na(data2p$city) | data2p$city==""), ]
data2p1$city <- gsub("SANDY SPRING", "ASHTON-SANDY SPRING", data2p1$city)
data2p1$city <- gsub("ASHTON", "ASHTON-SANDY SPRING", data2p1$city)
head(data2p1)

data2p2 <- filter(data2p1,
                  city == "ASHTON-SANDY SPRING" | city == "BARNESVILLE"| city ==
                  "BEALLSVILLE"| city == "BETHESDA" | city == "BOYDS"| city == 
                  "BRINKLOW"| city == "BROOKEVILLE"| city == "CABIN JOHN"| city
                  == "CHEVY CHASE"| city == "CLARKSBURG" | city == "DAMASCUS"| city
                  == "DERWOOD"| city == "DICKERSON"| city == "GAITHERSBURG"| city ==
                  "GARRETT PARK" | city == "GERMANTOWN" | city == "GLEN ECHO" | city 
                  == "KENSINGTON"| city == "MONTGOMERY VILLAGE"| city == "OLNEY"| city 
                  == "POOLESVILLE"| city == "POTOMAC"| city == "ROCKVILLE"| city == 
                  "SILVER SPRING" | city == "SPENCERVILLE"| city == "WASHINGTON GROVE"
                  )
dim(data2p2)

data2pcf <- data2p2[-c(1:4, 7, 9, 13, 14, 16:17, 25, 26)]
dim(data2pcf)

data2pcf <- filter(data2pcf, 
                  Police.District.Number == "1D" | Police.District.Number == "2D" |
                  Police.District.Number == "3D" | Police.District.Number == "4D" |
                  Police.District.Number == "5D" | Police.District.Number == "6D"
                  )
dim(data2pcf)

data2pcf <- filter(data2pcf, 
                  Priority == "0" | Priority == "1" | Priority == "2" | Priority == "3"
                  | Priority == "4"
                  )
head(data2pcf)

#Split date and time
data2pcf$datetime <- as.POSIXct(data2pcf$End.Time, 
                                format = "%m/%d/%Y %H:%M"
                                )

data2pc <- transform(data2pcf, 
                     time = format(datetime, "%T"), 
                     date = format(datetime, "%m/%d/%Y")
                     )

#drop Brookville due to outlier with big number
data2pc <- filter(data2pc, city !="BROOKEVILLE") 
data2pc <- data2pc[-c(5, 6)]
head(data2pc)
```

#### Data3: Population of Montgomery County in 2010
```{r}
names(data3pop)[names(data3pop) == "City"] <- "city"

data3popc <- filter(data3pop, 
                    city == "ASHTON-SANDY SPRING" | city == "BARNESVILLE"| city ==
                    "BEALLSVILLE"| city == "BETHESDA" | city == "BOYDS"| city == 
                    "BRINKLOW"| city == "BROOKEVILLE"| city == "CABIN JOHN"| city ==
                    "CHEVY CHASE"| city == "CLARKSBURG" | city == "DAMASCUS"| city ==
                    "DERWOOD"| city == "DICKERSON"| city == "GAITHERSBURG"| city == 
                    "GARRETT PARK" | city == "GERMANTOWN" | city == "GLEN ECHO" | city
                    == "KENSINGTON"| city == "MONTGOMERY VILLAGE"| city == "OLNEY"| city
                    == "POOLESVILLE"| city == "POTOMAC"| city == "ROCKVILLE"| city ==
                    "SILVER SPRING" | city == "SPENCERVILLE"| city == "WASHINGTON GROVE"
                    )

#drop Brookville due to outlier with big number
data3popc <- filter(data3popc, city !="BROOKEVILLE") 
data3popc <- data3popc[-c(2: 4)]
head(data3popc)
```

## Getting some tables from a dataset - Police Dispatched Incidents
### Total Police Dispatched Incidents from 2017 to 2019
```{r}
data2pctable <- table(data2pc$city, 
                      data2pc$Priority)
names(dimnames(data2pctable)) <- c("city", "Severity")
data2pctable

#convert the datatable to a dataframe
data2pcdf <- as.data.frame(data2pctable)
head(data2pcdf)

#give this description
data2pcdf2 <- data.frame(unclass(table(data2pc$city, 
                                       data2pc$Priority))
                         )
data2pcdf2$city <- row.names(data2pcdf2)
head(data2pcdf2)

data2pcRS <- rowSums(data2pctable)
head(data2pcRS)

summary(data2pcRS)
rowMeans(data2pctable)

data2pcCS <- colSums(data2pctable)
head(data2pcCS)

summary(data2pcCS)
colMeans(data2pctable)

#Severity / Year / Hour
data2pc171819 <- filter(data2pc, 
                        year(datetime) == 2017 || year(datetime) == 2018 || 
                        year(datetime) == 2019
                        )
head(data2pc171819)

data2pc171819$year <- year(data2pc171819$datetime)
data2pc171819 <- data2pc171819[-c(1, 3:12, 14:15)]
data2pc171819$hour <- hour(data2pc171819$datetime)
data2pc171819 <- data2pc171819[-c(2)]
data2pc171819$Priority <- as.numeric(data2pc171819$Priority)
head(data2pc171819)



tbpc171819 <- table(data2pc171819$Priority, data2pc171819$hour, data2pc171819$year)
head(tbpc171819)

tbpc171819df <- as.data.frame(tbpc171819)
head(tbpc171819df)
names(tbpc171819df)[names(tbpc171819df) == "Var1"] <- "severity"
names(tbpc171819df)[names(tbpc171819df) == "Var2"] <- "hour"
names(tbpc171819df)[names(tbpc171819df) == "Var3"] <- "year"
head(tbpc171819df)


#barplot(tbpc171819)

```

### - Police Dispatched Incidents 2017
##### Split the year and time
```{r}
#2017 whole year
data2pc17 <- filter(data2pc, year(datetime) == 2017)
head(data2pc17)

pc17table <- table(data2pc17$Priority, data2pc17$city)
rowSums(pc17table)

hmdfpc17 <- data2pc17[-c(1, 3:12, 14:15)]
hmdfpc17$hour <- hour(hmdfpc17$datetime)
hmdfpc17 <- hmdfpc17[-c(2)]
hmdfpc17$Priority <- as.numeric(hmdfpc17$Priority)
head(hmdfpc17)

tbpc17 <- table(hmdfpc17$Priority, hmdfpc17$hour)
head(tbpc17)

hourtable <- table(hmdfpc17$hour)
density <- density(hmdfpc17$hour)
barplot(tbpc17)

tbpc17df <- as.data.frame(tbpc17)
names(tbpc17df)[names(tbpc17df) == "Var1"] <- "severity"
names(tbpc17df)[names(tbpc17df) == "Var2"] <- "hour"
head(tbpc17df)

htpc17 <- ggplot(tbpc17df, 
                 aes(hour, severity, fill = Freq)
                 ) + 
          geom_tile() + 
          scale_fill_gradient(low = "white", high = "orange") +
          geom_text(aes(label = Freq), size = 3) +
          ggtitle("2017 Hourly Crime per Severity (0 = most dangerous)")
htpc17
```

```{r}
#split the time quarterly in a day
#2017 Day1: 00:00 to 05:59
data2pc17td1 <- filter(data2pc17, hour(datetime) >= 0 & hour(datetime) < 6)
head(data2pc17td1)

day1pc17 <- data2pc17td1[-c(1, 3:12, 14:15)]
day1pc17$hour <- hour(day1pc17$datetime)
day1pc17 <- day1pc17[-c(2)]
day1pc17$Priority <- as.numeric(day1pc17$Priority)
head(day1pc17)

d1pc17table <- table(day1pc17$Priority, day1pc17$hour)
head(d1pc17table)

d1pc17hrtable <- table(day1pc17$hour)
d1pc17density <- density(day1pc17$hour)
barplot(d1pc17table)

d1pc17tbdf <- as.data.frame(d1pc17table)
names(d1pc17tbdf)[names(d1pc17tbdf) == "Var1"] <- "severity"
names(d1pc17tbdf)[names(d1pc17tbdf) == "Var2"] <- "hour"
head(d1pc17tbdf)


#2017 Day2: 06:00 to 11:59
data2pc17td2 <- filter(data2pc17, hour(datetime) >= 6 & hour(datetime) < 12)
head(data2pc17td2)

day2pc17 <- data2pc17td2[-c(1, 3:12, 14:15)]
day2pc17$hour <- hour(day2pc17$datetime)
day2pc17 <- day2pc17[-c(2)]
day2pc17$Priority <- as.numeric(day2pc17$Priority)
head(day2pc17)

d2pc17table <- table(day2pc17$Priority, day2pc17$hour)
head(d2pc17table)

d2pc17hrtable <- table(day2pc17$hour)
d2pc17density <- density(day2pc17$hour)
barplot(d2pc17table)

d2pc17tbdf <- as.data.frame(d2pc17table)
names(d2pc17tbdf)[names(d2pc17tbdf) == "Var1"] <- "severity"
names(d2pc17tbdf)[names(d2pc17tbdf) == "Var2"] <- "hour"
head(d2pc17tbdf)


#2017 Day3: 12:00 to 17:59
data2pc17tn1 <- filter(data2pc17, hour(datetime) >= 12 & hour(datetime) < 18)
head(data2pc17tn1)

day3pc17 <- data2pc17tn1[-c(1, 3:12, 14:15)]
day3pc17$hour <- hour(day3pc17$datetime)
day3pc17 <- day3pc17[-c(2)]
day3pc17$Priority <- as.numeric(day3pc17$Priority)
head(day3pc17)

d3pc17table <- table(day3pc17$Priority, day3pc17$hour)
head(d3pc17table)

d3pc17hrtable <- table(day3pc17$hour)
d3pc17density <- density(day3pc17$hour)
barplot(d3pc17table)

d3pc17tbdf <- as.data.frame(d3pc17table)
names(d3pc17tbdf)[names(d3pc17tbdf) == "Var1"] <- "severity"
names(d3pc17tbdf)[names(d3pc17tbdf) == "Var2"] <- "hour"
head(d3pc17tbdf)


#2017 Day4: 18:00 to 23:59
data2pc17tn2 <- filter(data2pc17, hour(datetime) >= 18 & hour(datetime) < 24)
head(data2pc17tn2)

day4pc17 <- data2pc17tn2[-c(1, 3:12, 14:15)]
day4pc17$hour <- hour(day4pc17$datetime)
day4pc17 <- day4pc17[-c(2)]
day4pc17$Priority <- as.numeric(day4pc17$Priority)
head(day4pc17)

d4pc17table <- table(day4pc17$Priority, day4pc17$hour)
head(d4pc17table)

d4pc17hrtable <- table(day4pc17$hour)
d4pc17density <- density(day4pc17$hour)
barplot(d4pc17table)

d4pc17tbdf <- as.data.frame(d4pc17table)
names(d4pc17tbdf)[names(d4pc17tbdf) == "Var1"] <- "severity"
names(d4pc17tbdf)[names(d4pc17tbdf) == "Var2"] <- "hour"
head(d4pc17tbdf)

vd4pc17tbdf <- {ggplot(d4pc17tbdf,
                       aes(x = severity, y = Freq, fill = severity)
                       ) + 
                geom_violin(trim = FALSE) +
                stat_summary(fun.y = median, geom = "pointrange", mult = 1, color = "red")
                } %>% 
                ggplotly %>% 
                config(displayModeBar = F)
vd4pc17tbdf
```


#### combine Day1, 2, 3, 4 in 2017 Data
```{r}
day1234pc17 <- do.call("rbind", list(d1pc17tbdf, d2pc17tbdf, d3pc17tbdf, d4pc17tbdf))
head(day1234pc17)

day1234pc17gg <- ggplot(day1234pc17, 
                        aes(x = hour, y = Freq, group = severity, 
                            shape = severity, color=severity)
                            ) + 
                geom_line() + 
                geom_point(aes(text = 
                               paste(paste("Hour: ", hour, "<br>"),
                               paste("Frequency: ", Freq, "<br>"),
                               paste("Severity: ", severity))),
                            size = 2, 
                            data = day1234pc17
                           ) +
                ggtitle("2017 Hourly Frequency of Severity") +
                theme(axis.text.x = element_text(size = 5)) +
                scale_x_discrete("Hour", breaks = labels, labels = labels) +
                scale_y_continuous("Frequency") +
                facet_grid(.~severity)
day1234pc17gg

day1234pc17gp <- ggplotly(day1234pc17gg, tooltip =  "text") %>% 
                 config(displayModeBar = F)
day1234pc17gp


day1234pc17gg2 <- ggplot(day1234pc17, 
                         aes(x=hour, y=Freq, group=severity, shape=severity,
                            color=severity)
                            ) + 
                  geom_line() + 
                  geom_point(aes(text = 
                                 paste(paste("Hour: ", hour, "<br>"),
                                 paste("Frequency: ", Freq, "<br>"),
                                 paste("Severity: ", severity))),
                              size = 2.5, 
                              data = day1234pc17
                             ) +
                  ggtitle("2017 Hourly Frequency of Severity") +
                  theme(axis.text.x = element_text(size = 10)) +
                  scale_x_discrete("Hour", breaks = labels, labels = labels) +
                  scale_y_continuous("Frequency")
day1234pc17gg2

day1234pc17gp2 <- ggplotly(day1234pc17gg2, tooltip =  "text") %>% 
                  config(displayModeBar = F)
day1234pc17gp2
```





```{r}
#City 2017
data2pc17tb <- table(data2pc17$city, data2pc17$Priority)
names(dimnames(data2pc17tb)) <- c("city", "Priority")
head(data2pc17tb)


#merge with Population
data2317tb <- merge(data2pc17tb, data3popc, all = TRUE)
data2317tb$rate <- round((data2317tb$Freq/data2317tb$Census.2010)*100, digits = 1)
head(data2317tb)


data2pc17sum <- rowSums(data2pc17tb)
head(data2pc17sum)
summary(data2pc17sum)

data2pc17sumdf <- as.data.frame(data2pc17sum)
names(dimnames(data2pc17sumdf)) <- c("city", "Total")
data2pc17sumdf$Total <- data2pc17sumdf$data2pc17sum
data2pc17sumdf$city <- row.names(data2pc17sumdf)
data2pc17sumdf <- data2pc17sumdf[-c(1)]
head(data2pc17sumdf)

#Priority 2017
data2pc17tb2 <- table(data2pc17$Priority, data2pc17$city)
names(dimnames(data2pc17tb2)) <- c("Priority", "city")
head(data2pc17tb2)

data2pc17sum2 <- rowSums(data2pc17tb2)
head(data2pc17sum2)
summary(data2pc17sum2)

data2pc17sumdf2 <- as.data.frame(data2pc17sum2)
names(dimnames(data2pc17sumdf2)) <- c("Severity", "Total")
data2pc17sumdf2$Total <- data2pc17sumdf2$data2pc17sum
data2pc17sumdf2$Severity <- row.names(data2pc17sumdf2)
data2pc17sumdf2 <- data2pc17sumdf2[-c(1)]
head(data2pc17sumdf2)



#conver the data.table to a dataframe
data2pc17df <- as.data.frame(data2pc17tb)
data2pc17df <- data2pc17df[-c(1)]
head(data2pc17df)

#show 5 numbers and outliers
pcbox17 <- ggplot(data2pc17df, 
                  aes(x = Priority, y = Freq, fill = Priority)
                  ) +
           geom_boxplot(outlier.colour = "black", outlier.shape = 1, outlier.size = 2) +
           theme(axis.text.x = element_text(angle = 0, hjust = 0.9)) +
           ggtitle("2017 Crime Count of Severity") +
           xlab("Severity") +
           ylab("Count") +
           theme(legend.position = "right") +
           labs(fill = "Severity")
pcbox17
pcbox17gg <- ggplotly(pcbox17) %>% config(displayModeBar = F)
pcbox17gg

#show 5 numbers and outliers w/ rate
head(data2317tb, 10)
data23box17 <- ggplot(data2317tb, 
                  aes(x = Priority, y = rate, fill = Priority)
                  ) +
           geom_boxplot(outlier.colour = "black", outlier.shape = 1, outlier.size = 2) +
           theme(axis.text.x = element_text(angle = 0, hjust = 0.9)) +
           ggtitle("2017 Crime Rate by Severity") +
           xlab("Severity") +
           ylab("Rate") +
           theme(legend.position = "right") +
           labs(fill = "Severity")
data23box17

data23box17gg <- ggplotly(data23box17) %>% config(displayModeBar = F)
data23box17gg


```


### - Police Dispatched Incidents 2018
#### Split the year and time
```{r}
#2018 whole year
data2pc18 <- filter(data2pc, year(datetime) == 2018)
head(data2pc18)

hmdfpc18 <- data2pc18[-c(1, 3:12, 14:15)]
hmdfpc18$hour <- hour(hmdfpc18$datetime)
hmdfpc18 <- hmdfpc18[-c(2)]
hmdfpc18$Priority <- as.numeric(hmdfpc18$Priority)
head(hmdfpc18)

tbpc18 <- table(hmdfpc18$Priority, hmdfpc18$hour)
head(tbpc18)

hourtable <- table(hmdfpc18$hour)
density <- density(hmdfpc18$hour)
barplot(tbpc18)

tbpc18df <- as.data.frame(tbpc18)
names(tbpc18df)[names(tbpc18df) == "Var1"] <- "severity"
names(tbpc18df)[names(tbpc18df) == "Var2"] <- "hour"
head(tbpc18df)

htpc18 <- ggplot(tbpc18df, 
                 aes(hour, severity, fill = Freq)
                 ) + 
          geom_tile() +  
          scale_fill_gradient(low = "white", high = "blue") +
          geom_text(aes(label = Freq), size = 3) +
          ggtitle("2018 Hourly Crime per Severity (0 = most dangerous)")
htpc18
```

```{r}
#split the time quarterly in a day
#2018 Day1: 00:00 to 05:59
data2pc18td1 <- filter(data2pc18, hour(datetime) >= 0 & hour(datetime) < 6)
head(data2pc18td1)

day1pc18 <- data2pc18td1[-c(1, 3:12, 14:15)]
day1pc18$hour <- hour(day1pc18$datetime)
day1pc18 <- day1pc18[-c(2)]
day1pc18$Priority <- as.numeric(day1pc18$Priority)
head(day1pc18)

d1pc18table <- table(day1pc18$Priority, day1pc18$hour)
head(d1pc18table)

d1pc18hrtable <- table(day1pc18$hour)
d1pc18density <- density(day1pc18$hour)
barplot(d1pc18table)

d1pc18tbdf <- as.data.frame(d1pc18table)
names(d1pc18tbdf)[names(d1pc18tbdf) == "Var1"] <- "severity"
names(d1pc18tbdf)[names(d1pc18tbdf) == "Var2"] <- "hour"
head(d1pc18tbdf)



#2018 Day2: 06:00 to 11:59
data2pc18td2 <- filter(data2pc18, hour(datetime) >= 6 & hour(datetime) < 12)
head(data2pc18td2)

day2pc18 <- data2pc18td2[-c(1, 3:12, 14:15)]
day2pc18$hour <- hour(day2pc18$datetime)
day2pc18 <- day2pc18[-c(2)]
day2pc18$Priority <- as.numeric(day2pc18$Priority)
head(day2pc18)

d2pc18table <- table(day2pc18$Priority, day2pc18$hour)
head(d2pc18table)

d2pc18hrtable <- table(day2pc18$hour)
d2pc18density <- density(day2pc18$hour)
barplot(d2pc18table)

d2pc18tbdf <- as.data.frame(d2pc18table)
names(d2pc18tbdf)[names(d2pc18tbdf) == "Var1"] <- "severity"
names(d2pc18tbdf)[names(d2pc18tbdf) == "Var2"] <- "hour"
head(d2pc18tbdf)




#2018 Day3: 12:00 to 17:59
data2pc18tn1 <- filter(data2pc18, hour(datetime) >= 12 & hour(datetime) < 18)
head(data2pc18tn1)

day3pc18 <- data2pc18tn1[-c(1, 3:12, 14:15)]
day3pc18$hour <- hour(day3pc18$datetime)
day3pc18 <- day3pc18[-c(2)]
day3pc18$Priority <- as.numeric(day3pc18$Priority)
head(day3pc18)

d3pc18table <- table(day3pc18$Priority, day3pc18$hour)
head(d3pc18table)

d3pc18hrtable <- table(day3pc18$hour)
d3pc18density <- density(day3pc18$hour)
barplot(d3pc18table)

d3pc18tbdf <- as.data.frame(d3pc18table)
names(d3pc18tbdf)[names(d3pc18tbdf) == "Var1"] <- "severity"
names(d3pc18tbdf)[names(d3pc18tbdf) == "Var2"] <- "hour"
head(d3pc18tbdf)



#2018 Day4: 18:00 to 23:59
data2pc18tn2 <- filter(data2pc18, hour(datetime) >= 18 & hour(datetime) < 24)
head(data2pc18tn2)

day4pc18 <- data2pc18tn2[-c(1, 3:12, 14:15)]
day4pc18$hour <- hour(day4pc18$datetime)
day4pc18 <- day4pc18[-c(2)]
day4pc18$Priority <- as.numeric(day4pc18$Priority)
head(day4pc18)

d4pc18table <- table(day4pc18$Priority, day4pc18$hour)
head(d4pc18table)

d4pc18hrtable <- table(day4pc18$hour)
d4pc18density <- density(day4pc18$hour)
barplot(d4pc18table)

d4pc18tbdf <- as.data.frame(d4pc18table)
names(d4pc18tbdf)[names(d4pc18tbdf) == "Var1"] <- "severity"
names(d4pc18tbdf)[names(d4pc18tbdf) == "Var2"] <- "hour"
head(d4pc18tbdf)
```

#### combine Day1, 2, 3, 4 in 2018 Data
```{r}
day1234pc18 <- do.call("rbind", list(d1pc18tbdf, d2pc18tbdf, d3pc18tbdf, d4pc18tbdf))
head(day1234pc18)

day1234pc18gg <- ggplot(day1234pc18, 
                        aes(x = hour, y = Freq, group = severity, shape = severity,
                            color = severity)
                            ) + 
                 geom_line() + 
                 geom_point(aes(text = 
                                paste(paste("Hour: ", hour, "<br>"),
                                paste("Frequency: ", Freq, "<br>"),
                                paste("Severity: ", severity))),
                             size = 2, 
                             data = day1234pc18
                            ) +
                 ggtitle("2018 Hourly Frequency of Severity") +
                 theme(axis.text.x = element_text(size = 5)) +
                 scale_x_discrete("Hour", breaks = labels, labels = labels) +
                 scale_y_continuous("Frequency") +
                 facet_grid(.~severity )
day1234pc18gg

day1234pc18gp <- ggplotly(day1234pc18gg, tooltip =  "text") %>% 
                 config(displayModeBar = F)
day1234pc18gp


day1234pc18gg2 <- ggplot(day1234pc18, 
                         aes(x = hour, y = Freq, group = severity, shape = severity,
                             color = severity)
                             ) + 
                  geom_line() + 
                  geom_point(aes(text = 
                                 paste(paste("Hour: ", hour, "<br>"),
                                 paste("Frequency: ", Freq, "<br>"),
                                 paste("Severity: ", severity))),
                              size = 2.5, 
                              data = day1234pc18
                             ) +
                  ggtitle("2018 Hourly Frequency of Severity") +
                  theme(axis.text.x = element_text(size = 10)) +
                  scale_x_discrete("Hour", breaks = labels, labels = labels) +
                  scale_y_continuous("Frequency")
day1234pc18gg2

day1234pc18gp2 <- ggplotly(day1234pc18gg2, tooltip =  "text") %>% 
                  config(displayModeBar = F)
day1234pc18gp2
```


```{r}
#City 2018
data2pc18tb <- table(data2pc18$city, data2pc18$Priority)
names(dimnames(data2pc18tb)) <- c("city", "Priority")
head(data2pc18tb)


#merge with Population
data2318tb <- merge(data2pc18tb, data3popc, all = TRUE)
data2318tb$rate <- round((data2318tb$Freq/data2318tb$Census.2010)*100, digits = 1)
head(data2318tb)


data2pc18sum <- rowSums(data2pc18tb)
head(data2pc18sum)
summary(data2pc18sum)

data2pc18sumdf <- as.data.frame(data2pc18sum)
names(dimnames(data2pc18sumdf)) <- c("city", "Total")
data2pc18sumdf$Total <- data2pc18sumdf$data2pc18sum
data2pc18sumdf$city <- row.names(data2pc18sumdf)
data2pc18sumdf <- data2pc18sumdf[-c(1)]
head(data2pc18sumdf)


#Priority 2018
data2pc18tb2 <- table(data2pc18$Priority, data2pc18$city)
names(dimnames(data2pc18tb2)) <- c("Priority", "city")
head(data2pc18tb2)

data2pc18sum2 <- rowSums(data2pc18tb2)
head(data2pc18sum2)
summary(data2pc18sum2)

data2pc18sumdf2 <- as.data.frame(data2pc18sum2)
names(dimnames(data2pc18sumdf2)) <- c("Severity", "Total")
data2pc18sumdf2$Total <- data2pc18sumdf2$data2pc18sum
data2pc18sumdf2$Severity <- row.names(data2pc18sumdf2)
data2pc18sumdf2 <- data2pc18sumdf2[-c(1)]
head(data2pc18sumdf2)

#conver the data.table to a dataframe
data2pc18df <- as.data.frame(data2pc18tb)
data2pc18df <- data2pc18df[-c(1)]
head(data2pc18df)

#show 5 numbers and outliers
pcbox18 <- ggplot(data2pc18df, 
                  aes(x = Priority, y = Freq, fill = Priority)
                  ) +
           geom_boxplot(outlier.colour = "black", outlier.shape = 1, outlier.size = 2) +
           theme(axis.text.x = element_text(angle = 0, hjust = 0.9)) +
           ggtitle("2018 Crime Count of Severity") +
           xlab("Severity") +
           ylab("Count") +
           theme(legend.position = "right") +
           labs(fill = "Severity")
pcbox18

pcbox18gg <- ggplotly(pcbox18) %>% config(displayModeBar = F)
pcbox18gg

#show 5 numbers and outliers w/ rate
head(data2318tb, 10)
data23box18 <- ggplot(data2318tb, 
                  aes(x = Priority, y = rate, fill = Priority)
                  ) +
           geom_boxplot(outlier.colour = "black", outlier.shape = 1, outlier.size = 2) +
           theme(axis.text.x = element_text(angle = 0, hjust = 0.9)) +
           ggtitle("2018 Crime Rate by Severity") +
           xlab("Severity") +
           ylab("Rate") +
           theme(legend.position = "right") +
           labs(fill = "Severity")
data23box18

data23box18gg <- ggplotly(data23box18) %>% config(displayModeBar = F)
data23box18gg


```

### - Police Dispatched Incidents 2019
#### Split the year and time
```{r}
#2019 Whole year
data2pc19 <- filter(data2pc, year(datetime) == 2019)
head(data2pc19)

hmdfpc19 <- data2pc19[-c(1, 3:12, 14:15)]
hmdfpc19$hour <- hour(hmdfpc19$datetime)
hmdfpc19 <- hmdfpc19[-c(2)]
hmdfpc19$Priority <- as.numeric(hmdfpc19$Priority)
head(hmdfpc19)

tbpc19 <- table(hmdfpc19$Priority, hmdfpc19$hour)
head(tbpc19)

hourtable <- table(hmdfpc19$hour)
density <- density(hmdfpc19$hour)
barplot(tbpc19)

tbpc19df <- as.data.frame(tbpc19)
names(tbpc19df)[names(tbpc19df) == "Var1"] <- "severity"
names(tbpc19df)[names(tbpc19df) == "Var2"] <- "hour"
head(tbpc19df)

htpc19 <- ggplot(tbpc19df, 
                 aes(hour, severity, fill = Freq)
                 ) + 
          geom_tile() +  scale_fill_gradient(low = "white", high = "red") +
          geom_text(aes(label = Freq), size = 3) +
          ggtitle("2019 Hourly Crime per Severity (0 = most dangerous)")
htpc19
```

```{r}
#split the time quarterly in a day
#2019 Day1: 00:00 to 05:59
data2pc19td1 <- filter(data2pc19, hour(datetime) >= 0 & hour(datetime) < 6)
head(data2pc19td1)

day1pc19 <- data2pc19td1[-c(1, 3:12, 14:15)]
day1pc19$hour <- hour(day1pc19$datetime)
day1pc19 <- day1pc19[-c(2)]
day1pc19$Priority <- as.numeric(day1pc19$Priority)
head(day1pc19)

d1pc19table <- table(day1pc19$Priority, day1pc19$hour)
head(d1pc19table)

d1pc19hrtable <- table(day1pc19$hour)
d1pc19density <- density(day1pc19$hour)
barplot(d1pc19table)

d1pc19tbdf <- as.data.frame(d1pc19table)
names(d1pc19tbdf)[names(d1pc19tbdf) == "Var1"] <- "severity"
names(d1pc19tbdf)[names(d1pc19tbdf) == "Var2"] <- "hour"
head(d1pc19tbdf)



#2019 Day2: 06:00 to 11:59
data2pc19td2 <- filter(data2pc19, hour(datetime) >= 6 & hour(datetime) < 12)
head(data2pc19td2)

day2pc19 <- data2pc19td2[-c(1, 3:12, 14:15)]
day2pc19$hour <- hour(day2pc19$datetime)
day2pc19 <- day2pc19[-c(2)]
day2pc19$Priority <- as.numeric(day2pc19$Priority)
head(day2pc19)

d2pc19table <- table(day2pc19$Priority, day2pc19$hour)
head(d2pc19table)

d2pc19hrtable <- table(day2pc19$hour)
d2pc19density <- density(day2pc19$hour)
barplot(d2pc19table)

d2pc19tbdf <- as.data.frame(d2pc19table)
names(d2pc19tbdf)[names(d2pc19tbdf) == "Var1"] <- "severity"
names(d2pc19tbdf)[names(d2pc19tbdf) == "Var2"] <- "hour"
head(d2pc19tbdf)



#2019 Day3: 12:00 to 17:59
data2pc19tn1 <- filter(data2pc19, hour(datetime) >= 12 & hour(datetime) < 18)
head(data2pc19tn1)

day3pc19 <- data2pc19tn1[-c(1, 3:12, 14:15)]
day3pc19$hour <- hour(day3pc19$datetime)
day3pc19 <- day3pc19[-c(2)]
day3pc19$Priority <- as.numeric(day3pc19$Priority)
head(day3pc19)

d3pc19table <- table(day3pc19$Priority, day3pc19$hour)
head(d3pc19table)

d3pc19hrtable <- table(day3pc19$hour)
d3pc19density <- density(day3pc19$hour)
barplot(d3pc19table)

d3pc19tbdf <- as.data.frame(d3pc19table)
names(d3pc19tbdf)[names(d3pc19tbdf) == "Var1"] <- "severity"
names(d3pc19tbdf)[names(d3pc19tbdf) == "Var2"] <- "hour"
head(d3pc19tbdf)



#2019 Day4: 18:00 to 23:59
data2pc19tn2 <- filter(data2pc19, hour(datetime) >= 18 & hour(datetime) < 24)
head(data2pc19tn2)

day4pc19 <- data2pc19tn2[-c(1, 3:12, 14:15)]
day4pc19$hour <- hour(day4pc19$datetime)
day4pc19 <- day4pc19[-c(2)]
day4pc19$Priority <- as.numeric(day4pc19$Priority)
head(day4pc19)

d4pc19table <- table(day4pc19$Priority, day4pc19$hour)
head(d4pc19table)

d4pc19hrtable <- table(day4pc19$hour)
d4pc19density <- density(day4pc19$hour)
barplot(d4pc19table)

d4pc19tbdf <- as.data.frame(d4pc19table)
names(d4pc19tbdf)[names(d4pc19tbdf) == "Var1"] <- "severity"
names(d4pc19tbdf)[names(d4pc19tbdf) == "Var2"] <- "hour"
head(d4pc19tbdf)
```


#### combine Day1, 2, 3, 4 in 2019 Data
```{r}
day1234pc19 <- do.call("rbind", list(d1pc19tbdf, d2pc19tbdf, d3pc19tbdf, d4pc19tbdf))
head(day1234pc19)

day1234pc19gg <- ggplot(day1234pc19, 
                        aes(x = hour, y = Freq, group = severity, shape = severity,
                            color = severity)
                            ) + 
                 geom_line() + 
                 geom_point(aes(text = 
                                paste(paste("Hour: ", day1234pc19$hour, "<br>"),
                                paste("Frequency: ", day1234pc19$Freq, "<br>"),
                                paste("Severity: ", day1234pc19$severity))),
                             size = 2, 
                             data = day1234pc19
                            ) +
                 ggtitle("2019 Hourly Frequency of Severity") +
                 theme(axis.text.x = element_text(size = 5)) +
                 scale_x_discrete("Hour", breaks = labels, labels = labels) +
                 scale_y_continuous("Frequency") +
                 facet_grid(.~severity )
day1234pc19gg

day1234pc19gp <- ggplotly(day1234pc19gg, tooltip =  "text") %>% 
                 config(displayModeBar = F)
day1234pc19gp


#without animation
day1234pc19gg2 <- ggplot(day1234pc19, 
                         aes(x = hour, y = Freq, group = severity, 
                             shape = severity, color = severity)
                         ) + 
                   geom_line() + 
                   geom_point(aes(text = 
                                  paste(paste("Hour: ", hour, "<br>"),
                                  paste("Frequency: ", Freq, "<br>"),
                                  paste("Severity: ", severity))),
                               size = 2.5, 
                               data = day1234pc19
                              ) +
                   ggtitle("2019 Hourly Frequency of Severity") +
                   theme(axis.text.x = element_text(size = 10)) +
                   scale_x_discrete("Hour", breaks = labels, labels = labels) +
                   scale_y_continuous("Frequency")
day1234pc19gg2

##with animation but it won't be used
#day1234pc19gg22 <- ggplot(day1234pc19, 
#                         aes(x = hour, y = Freq, group = severity, 
#                             shape = severity, color = severity)) + 
#                  geom_line() + 
#                  geom_point(aes(text = 
#                                 paste(paste("Hour: ", hour, "<br>"),
#                                 paste("Frequency: ", Freq, "<br>"),
#                                 paste("Severity: ", severity))),
#                              size = 1, 
#                              data = day1234pc19
#                             ) +
#                  ggtitle("2019 Hourly Frequency of Severity") +
#                  theme(axis.text.x = element_text(size = 5)) +
#                  scale_x_discrete("Hour", breaks = labels, labels = labels) +
#                  scale_y_continuous("Frequency") +
#                  transition_reveal(as.numeric(hour))
#
#day1234pc19gg22
#
#day1234pc19gp22 <- ggplotly(day1234pc19gg2, tooltip =  "text")  %>% 
#                  config(displayModeBar = F)
#day1234pc19gp22


```



```{r}
#City 2019
data2pc19tb <- table(data2pc19$city, data2pc19$Priority)
names(dimnames(data2pc19tb)) <- c("city", "Priority")
head(data2pc19tb)

#merge with Population
data2319tb <- merge(data2pc19tb, data3popc, all = TRUE)
data2319tb$rate <- round((data2319tb$Freq/data2319tb$Census.2010)*100, digits = 1)
head(data2319tb)

data2pc19sum <- rowSums(data2pc19tb)
data2pc19sum
summary(data2pc19sum)


data2pc19sumdf <- as.data.frame(data2pc19sum)
names(dimnames(data2pc19sumdf)) <- c("city", "Total")
data2pc19sumdf$Total <- data2pc19sumdf$data2pc19sum
data2pc19sumdf$city <- row.names(data2pc19sumdf)
data2pc19sumdf <- data2pc19sumdf[-c(1)]
head(data2pc19sumdf)


#Priority 2019
data2pc19tb2 <- table(data2pc19$Priority, data2pc19$city)
names(dimnames(data2pc19tb2)) <- c("Priority", "city")
head(data2pc19tb2)

data2pc19sum2 <- rowSums(data2pc19tb2)
data2pc19sum2
summary(data2pc19sum2)

data2pc19sumdf2 <- as.data.frame(data2pc19sum2)
names(dimnames(data2pc19sumdf2)) <- c("Severity", "Total")
data2pc19sumdf2$Total <- data2pc19sumdf2$data2pc19sum
data2pc19sumdf2$Severity <- row.names(data2pc19sumdf2)
data2pc19sumdf2 <- data2pc19sumdf2[-c(1)]
head(data2pc19sumdf2)


#conver the data.table to a dataframe
data2pc19df <- as.data.frame(data2pc19tb)
data2pc19df <- data2pc19df[-c(1)]
head(data2pc19df)

#show 5 numbers and outliers w/ Frequency
pcbox19 <- ggplot(data2pc19df, 
                  aes(x = Priority, y = Freq, fill = Priority)
                  ) +
           geom_boxplot(outlier.colour = "black", outlier.shape = 1, outlier.size = 2) +
           theme(axis.text.x = element_text(angle = 0, hjust = 0.9)) +
           ggtitle("2019 Crime Count of Severity") +
           xlab("Severity") +
           ylab("Count") +
           theme(legend.position = "right") +
           labs(fill = "Severity")
pcbox19

pcbox19gg <- ggplotly(pcbox19) %>% config(displayModeBar = F)
pcbox19gg

#show 5 numbers and outliers w/ rate
head(data2319tb, 10)
data23box19 <- ggplot(data2319tb, 
                  aes(x = Priority, y = rate, fill = Priority)
                  ) +
           geom_boxplot(outlier.colour = "black", outlier.shape = 1, outlier.size = 2) +
           theme(axis.text.x = element_text(angle = 0, hjust = 0.9)) +
           ggtitle("2019 Crime Rate by Severity") +
           xlab("Severity") +
           ylab("Rate") +
           theme(legend.position = "right") +
           labs(fill = "Severity")
data23box19

data23box19gg <- ggplotly(data23box19) %>% config(displayModeBar = F)
data23box19gg


```



### Getting some tables from a dataset - Median House Price
```{r}
head(data1hc)
data1hyr <- melt(data1hc, 
                 city.var = c('city', 'year'), 
                 variable.name = 'year')
data1hyr$date <- as.Date(paste(data1hyr$year, "-01", sep =""))
head(data1hyr)

####Median House price 2017
data1ht17 <- filter(data1hyr, year(date) == 2017)
head(data1ht17)

data1ht17dec <- filter(data1hyr, year == "2017-12") #December of 2017 of Housing prices
head(data1ht17dec)

data1h17ln <-ggplot(data1ht17, 
                    aes(x = year, y = value, group = city)
                        ) +
             geom_line(aes(color = city)) +
             geom_point(aes(color = city, 
                            text = paste(paste("City: ", city, "<br>"),
                                         paste("Year: ", year, "<br>"),
                                         paste("Value: ", value))),
                            size = 2, 
                            data = data1ht17
                        ) +
             theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
             ggtitle("Median House Value 2017") +
             xlab ("Year") +
             ylab ("Value(USD$Dollar)") +
             theme(legend.position = "bottom")
data1h17ln

data1h17lngg <- ggplotly(data1h17ln, tooltip = "text") %>% config(displayModeBar = F)
data1h17lngg


####Median House Price 2018
data1ht18 <- filter(data1hyr, year(date) == 2018)
head(data1ht18)

data1ht18dec <- filter(data1hyr, year == "2018-12") #December of 2018 of Housing prices
head(data1ht18dec)


data1h18ln <-ggplot(data1ht18, 
                    aes(x = year, y = value, group = city)
                        ) +
             geom_line(aes(color = city)) +
             geom_point(aes(color = city,
                            text = paste(paste("City: ", city, "<br>"),
                                         paste("Year: ", year, "<br>"),
                                         paste("Value: ", value))),
                            size = 2, 
                            data = data1ht18
                        ) +
             theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
             ggtitle("Median House Value 2018") +
             xlab ("Year") +
             ylab ("Value(USD$Dollar)") +
             theme(legend.position = "bottom")
data1h18ln

data1h18lngg <- ggplotly(data1h18ln, tooltip = "text") %>% config(displayModeBar = F)
data1h18lngg

####Median House Price 2019
data1ht19 <- filter(data1hyr, year(date) == 2019)
head(data1ht19)

data1ht19dec <- filter(data1hyr, year == "2019-12") #December of 2019 of Housing prices
head(data1ht19dec)

data1h19ln <-ggplot(data1ht19, 
                    aes(x = year, y = value, group = city)
                    ) +
             geom_line(aes(color = city)) +
             geom_point(aes(color = city,
                            text = paste(paste("City: ", city, "<br>"),
                                         paste("Year: ", year, "<br>"),
                                         paste("Value: ", value))),
                            size = 2, 
                            data = data1ht19
                          ) +
             theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
             ggtitle("Median House Value 2019") +
             xlab ("Year") +
             ylab ("Value(USD$Dollar)") +
             theme(legend.position = "bottom")
data1h19ln

data1h19lngg <- ggplotly(data1h19ln, tooltip = "text") %>% config(displayModeBar = F)
data1h19lngg
```



### Merge three datasets - by city, city and December of each year from Housing, city, severity from Police, city and census2010 from population

####merge: 2017 Medien House Price, Police Dispached Incidents, and 2010 Population
```{r}
df12mrg17 <- merge(data1ht17dec, data2pc17sumdf,  all  = TRUE)
head(df12mrg17)
df123mrg17 <- merge(df12mrg17, data3popc,  all  = TRUE)
head(df123mrg17)

df123mrg17$rate <- round((df123mrg17$Total/df123mrg17$Census.2010)*100, digits = 1)
head(df123mrg17)

df123mrg17c <- df123mrg17[-c(2, 4:6)]
row.names(df123mrg17c) <- df123mrg17c$city
head(df123mrg17c)


df123result17 <- df123mrg17c[-1]
head(df123result17)

df123cor17 <- cor(df123result17)
df123cor17

corrplot(df123cor17, method="circle",
         title = "2017 Correlation b/w Median House price and Rate of Crime", 
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))

corrplot(df123cor17, method="pie",
         title = "2017 Correlation b/w Median House price and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))

corrplot(df123cor17, method="number",
         title = "2017 Correlation b/w Median House price and Rate of Crime", 
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))
```


####merge: 2018 Median House Price, Police Dispached Incidents, and 2010 Population
```{r}
df12mrg18 <- merge(data1ht18dec, data2pc18sumdf,  all  = TRUE)
#df12mrg18 <- df12mrg18[-c(5)]
head(df12mrg18)
df123mrg18 <- merge(df12mrg18, data3popc,  all  = TRUE)
head(df123mrg18)
df123mrg18$rate <- round((df123mrg18$Total/df123mrg18$Census.2010)*100, digits = 1)
head(df123mrg18)

df123mrg18c <- df123mrg18[-c(2, 4:6)]
row.names(df123mrg18c) <- df123mrg18c$city
head(df123mrg18c)


df123result18 <- df123mrg18c[-1]
head(df123result18)

df123cor18 <- cor(df123result18)
df123cor18

corrplot(df123cor18, method="circle",
         title = "2018 Correlation b/w Median House price and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))

corrplot(df123cor18, method="pie",
         title = "2018 Correlation b/w Median House price and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))

corrplot(df123cor18, method="number",
         title = "2018 Correlation b/w Median House price and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))
```



####merge: 2019 Median House Price, Police Dispached Incidents, and 2010 Population
```{r}
df12mrg19 <- merge(data1ht19dec, data2pc19sumdf,  all  = TRUE)
#df12mrg19 <- df12mrg19[-c(5)]
head(df12mrg19)
df123mrg19 <- merge(df12mrg19, data3popc,  all  = TRUE)
head(df123mrg19)
df123mrg19$rate <- round((df123mrg19$Total/df123mrg19$Census.2010)*100, digits = 1)
head(df123mrg19)

df123mrg19c <- df123mrg19[-c(2, 4:6)]
row.names(df123mrg19c) <- df123mrg19c$city
head(df123mrg19c)


df123result19 <- df123mrg19c[-1]
head(df123result19)

df123cor19 <- cor(df123result19)
df123cor19

corrplot(df123cor19, method = "circle", 
         title = "2019 Correlation b/w Median House pricee and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))

corrplot(df123cor19, method="pie", 
         title = "2019 Correlation b/w Median House price and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))

corrplot(df123cor19, method="number", 
         title = "2019 Correlation b/w Median House price and Rate of Crime",
         addCoef.col = "black", sig.level = 0.05, insig = "blank", mar=c(0,0,1,0),
         type = "upper", order = "hclust", col = brewer.pal(n = 8, name = "RdYlBu"))
```

#### combine all three years (2017, 2018, 2019)
```{r}
all3yr <- do.call("rbind", list(df123mrg17, df123mrg18, df123mrg19))
head(all3yr)


all3yrgg <- ggplot(all3yr, 
                   aes(x = city, y = rate, group = city, shape = year)
                   ) + 
            geom_point(aes(color = city, size = rate)) + 
            ggtitle("Yearly Crime Rate") +
            theme(axis.text.x = element_text(size = 5)) +
            theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
#           geom_text(aes(label = rate), vjust = -0.3, size = 4) +
            scale_x_discrete("City", breaks = labels, labels = labels) +
            scale_y_continuous("Crime rate(%=crime/population)") +
            facet_wrap( ~ year)
all3yrgg


all3yrballoon <- ggballoonplot(all3yr, 
                               fill = "rate"
                               )+
                 scale_fill_viridis_c(option = "C") +
                 xlab("City") +
                 ylab("Year") +
                 ggtitle("Yearly Crime Rate")
all3yrballoon

#2017
all3yr17 <- filter(all3yr, year == "2017-12") 
head(all3yr17)

all3yr17gg <- ggplot(all3yr17, 
                   aes(x = city, y = rate, group = city)
                   ) + 
              geom_point(aes(color = city, size = rate)) + 
              ggtitle("2017 Crime Rate by city") +
              theme(axis.text.x = element_text(size = 5, angle = 70, hjust = 0.9)) +
              theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
              geom_text(aes(label = rate), vjust = -0.3, size = 4) +
              scale_x_discrete("City", breaks = labels, labels = labels) +
              scale_y_continuous("Crime rate(%=crime/population)") +
              theme(legend.position = "right")

all3yr17gg

#2018
all3yr18 <- filter(all3yr, year == "2018-12") 
head(all3yr18)

all3yr18gg <- ggplot(all3yr18, 
                   aes(x = city, y = rate, group = city)
                   ) + 
              geom_point(aes(color = city, size = rate)) + 
              ggtitle("2018 Crime Rate by city") +
              theme(axis.text.x = element_text(size = 5, angle = 70, hjust = 0.9)) +
              theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
              geom_text(aes(label = rate), vjust = -0.3, size = 4) +
              scale_x_discrete("City", breaks = labels, labels = labels) +
              scale_y_continuous("Crime rate(%=crime/population)") +
              theme(legend.position = "right")

all3yr18gg


#2019
all3yr19 <- filter(all3yr, year == "2019-12") 
head(all3yr19)

all3yr19gg <- ggplot(all3yr19, 
                   aes(x = city, y = rate, group = city)
                   ) + 
              geom_point(aes(color = city, size = rate)) + 
              ggtitle("2019 Crime Rate by city") +
              theme(axis.text.x = element_text(size = 5, angle = 70, hjust = 0.9)) +
              theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
              geom_text(aes(label = rate), vjust = -0.3, size = 4) +
              scale_x_discrete("City", breaks = labels, labels = labels) +
              scale_y_continuous("Crime rate(%=crime/population)") +
              theme(legend.position = "right")

all3yr19gg

#place multiple plots together
#gridExtra::grid.arrange(data1h17ln, data1h18ln, data1h19ln, nrow=3)  
```




### check Which cities have the most severe types of crime in 3 years
```{r}
data2pcgr <- data2pc %>%
             group_by(city) %>%
             summarise(Priority = n())
head(data2pcgr)

data2pcbar <- ggplot(data2pcgr,
                     aes(x = city, y = Priority)
                     ) +
              geom_bar(fill = "#0073C2FF",
                       stat = "identity",
                       aes(text = paste(paste("City: ", city))),
                       size = 1, 
                       data = data2pcgr
                       ) +
              geom_text(aes(label = Priority),
                        vjust = -0.1
                        ) +
              theme(axis.text.x = element_text(angle = 70, hjust = 0.9)) +
              ggtitle("Total Severity of Police Dispatched Incidents from 2017 to 2019",
                      subtitle = "per City in Montgomery County, MD"
                      ) +
              ylab("Severity") +
              xlab("City")
data2pcbar
data2pcbargg <- ggplotly(data2pcbar, tooltip = "text") %>% config(displayModeBar = F)
data2pcbargg


data2pcall <- ggplot(data2pcdf, aes(x = city, y = Freq, fill = Severity)
                     ) +
              geom_bar(aes(fill = Severity,
                           text = paste(paste("City: ", city, "<br>"),
                                        paste("Severity: ", Severity, "<br"),
                                        paste("Frequency: ", Freq))),
                       size = 1,
                       data = data2pcdf,
                       stat = "identity",
                       position = position_dodge(0.9)
                       ) +
              theme(axis.text.x.bottom = element_text(angle = 70, hjust = 0.9)) +
              ggtitle("Total Severity of Police Dispatched Incidents from 2017 to 2019",
                      subtitle = "per city in Montgomery County, MD") +
              ylab("Count") +
              xlab("city") 
data2pcall

data2pcallgg <- ggplotly(data2pcall, tootip = "text") %>% config(displayModeBar = F)
data2pcallgg

pcplotly <- plot_ly(data2pcdf2, x =~city , y = ~X0, type = 'bar', name = '0')
pcplotly <- pcplotly %>% add_trace(y = ~X1, name = '1')
pcplotly <- pcplotly %>% add_trace(y = ~X2, name = '2')
pcplotly <- pcplotly %>% add_trace(y = ~X3, name = '3')
pcplotly <- pcplotly %>% add_trace(y = ~X4, name = '4')
pcplotly <- pcplotly %>% layout(yaxis = list(title = 'Freq'), 
                                barmode = 'group', 
                                title = "Total Severity of Police Dispatched Incidents from 2017 to 2019 \nper city in Montgomery County, MD"
                                )  %>%
                         add_annotations(text = "Severty",
                                         xref = "paper",
                                         yref = "paper",
                                         x = 1.02, xanchor = "left",
                                         y = 0.8, yanchor = "bottom",
                                         legendtitle = TRUE, showarrow = FALSE) %>%
                         layout(legend = list(y = 0.8, yanchor = "top")) %>%
                         config(displayModeBar = F)
pcplotly
```




```{r}

#maybe Top6 and Low6 cities in Severity rates
##2017
data23mg17 <-  merge(x = data2pc17sumdf, y = data3popc, by.x = "city", all.x = TRUE)
head(data23mg17)

##Rate: Total Severity / Population
data23mg17$rate <- round((data23mg17$Total/data23mg17$Census.2010)*100, digits = 1)
head(data23mg17)

data2317Top6 <- data23mg17 %>% 
                arrange(desc(rate)) %>% 
                slice(1:5)
data2317Top6 <- data2317Top6[-c(2)]
head(data2317Top6)

p1 = alluvial_wide(as.data.frame(data2317Top6), max_variables = 4, bins = 5)
parcats(p1, marginal_histograms = FALSE, hoverinfo = "none") %>% config(displayModeBar = F)



data2317Low6 <- data23mg17 %>% 
                arrange(rate) %>% 
                slice(1:5)
data2317Low6 <- data2317Low6[-c(2)]
head(data2317Low6)

p2 = alluvial_wide(as.data.frame(data2317Low6), max_variables = 4, bins = 5)
parcats(p2, marginal_histograms = FALSE, hoverinfo = "none") %>% config(displayModeBar = F)

```


```{r}

head(data2pcdf)
data2pcTop6 <- data2pcdf %>% 
               arrange(desc(Freq)) %>% 
               group_by(Severity) %>% slice(1:5)
head(data2pcTop6)

data2pcLow6 <- data2pcdf %>% 
               arrange(Freq) %>% 
               group_by(Severity) %>% slice(1:5)
head(data2pcLow6)


is_alluvia_form(as.data.frame(data2pcTop6), 
                axes = 1:3, silent = TRUE
                )
data2pcT6alluv <- ggplot(as.data.frame(data2pcTop6),
                         aes(y = Freq, axis1 = city, axis2 = Severity), alluvium = city
                         ) +
                  geom_alluvium(aes(fill = city, colour = city),
                                width = 1/4, alpha = 2/3, decreasing = NA
                                ) +
                  geom_stratum(width = 1/12, fill = "black", color = "grey") +
                  geom_label(stat = "stratum", infer.label = TRUE) +
                  scale_x_discrete(limits = c("Severity", "City"), expand = c(.05, .05)) +
                  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
                  scale_fill_brewer(type = "qual", palette = "Set1") +
                  ggtitle("Top 5 Cities in Severity")
data2pcT6alluv

is_alluvia_form(as.data.frame(data2pcLow6), 
                axes = 1:3, silent = TRUE
                )
data2pcL6alluv <- ggplot(as.data.frame(data2pcLow6),
                         aes(y = Freq, axis1 = city, axis2 = Severity), alluvium = city
                         ) +
                  geom_alluvium(aes(fill = city, colour = city),
                                width = 1/4, alpha = 2/3, decreasing = NA
                                ) +
                  geom_stratum(width = 1/12, fill = "black", color = "grey") +
                  geom_label(stat = "stratum", infer.label = TRUE) +
                  scale_x_discrete(limits = c("City", "Severity"), expand = c(.05, .05)) +
                  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
                  scale_fill_brewer(type = "qual", palette = "Set1") +
                  ggtitle("Low 6 Cities in Severity")
data2pcL6alluv


p = alluvial_wide(as.data.frame(data2pcTop6), max_variables = 3, bins = 5)
parcats(p, marginal_histograms = FALSE)

```




##Rate of crime by population
```{r}

##2018
data23m18 <-  merge(x = data2pc18sumdf, y = data3popc, by.x = "city", all.x = TRUE)
head(data23m18)

data23m18$rate <- round((data23m18$Total/data23m18$Census.2010)*100, digits = 1)
head(data23m18)


##2019
data23m19 <-  merge(x = data2pc19sumdf, y = data3popc, by.x = "city", all.x = TRUE)
head(data23m19)

data23m19$rate <- round((data23m19$Total/data23m19$Census.2010)*100, digits = 1)
head(data23m19)

```


### check Which cities have the least(amount) sever types of cirme
```{r}
data2pmsv0 <- filter(data2pc, 
                     Priority == "0")
head(data2pmsv0)
data2pm0hist <- data2pmsv0 %>%
                group_by(city) %>%
                summarise(Priority = n())
head(data2pm0hist)
data2pm0hist <- ggplot(data2pm0hist,
                       aes(x = city, y = Priority)
                       ) +
                geom_bar(fill = "red",
                         stat = "identity"
                         ) +
                geom_text(aes(label = Priority),
                          vjust = -0.3
                          ) +
                theme(axis.text.x = element_text(angle = 70, hjust = 0.9)) +
                ggtitle("Most Severity Rate (0) of Police Dispatched Incidents",
                         subtitle = "per city in Montgomery County, MD"
                        ) +
                ylab("Priority(Severity)") +
                xlab("city")


data3popbar <- ggplot(data3popc, 
                      aes(x = city, y = Census.2010)
                      ) +
               geom_bar(fill = "orange", stat = "identity") +
               geom_text(aes(label = Census.2010), vjust = -0.3, size = 4) +
               theme(axis.text.x = element_text(angle = 70, hjust = 0.9)) +
               theme(plot.title = element_text(hjust = 0, size = 10)) +
               ggtitle("Population of Cities in Montgomery County, MD",
                       subtitle = "(Source: Census Bureau 2010)"
                       ) +
               ylab("Count") +
               xlab("city")
data3popbar
data3popbargg <- ggplotly(data3popbar, tooltip = "text") %>% config(displayModeBar = F)
data3popbargg

data3popln <- ggplot(data3popc, 
                     aes(x = city, y = Census.2010)
                     ) +
              geom_linerange(aes(x = city, ymin = 0, ymax = Census.2010),
                             color = "gray", size = 1.5
                             ) +
              geom_point(aes(color = city,
                             text = paste(paste("City: ", city, "<br>"),
                                          paste("Population 2010: ", Census.2010))),
                         size = 2
                         ) +
              geom_text(aes(label = Census.2010), vjust = -0.6, size = 3) +
              theme(axis.text.x = element_text(angle = 70, hjust = 0.9)) +
              ggtitle("Population of Cities in Montgomery County, MD",
                       subtitle = "(Source: Census Bureau 2010)"
                      ) +
              ylab("Count") +
              xlab("city")
data3popln

data3poplngg <- ggplotly(data3popln, tooltip = "text") %>% config(displayModeBar = F)
data3poplngg

```


